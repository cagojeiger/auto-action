suite: 스케일링 기능 테스트
tests:
  - it: 기본 HorizontalPodAutoscaler가 올바르게 생성되어야 함
    template: hpa.yaml
    set:
      templateDefaults:
        web:
          autoscaling:
            enabled: true
            minReplicas: 2
            maxReplicas: 10
            metrics:
              - type: Resource
                resource:
                  name: cpu
                  target:
                    type: Utilization
                    averageUtilization: 80
      templates:
        - name: basic-hpa
          type: web
          image:
            repository: nginx
            tag: "latest"
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10
      - equal:
          path: spec.metrics[0].resource.target.type
          value: Utilization
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 80

  - it: 사용자 지정 HPA 설정이 올바르게 적용되어야 함
    template: hpa.yaml
    set:
      templateDefaults:
        web:
          autoscaling:
            enabled: true
            minReplicas: 2
            maxReplicas: 10
            metrics:
              - type: Resource
                resource:
                  name: cpu
                  target:
                    type: Utilization
                    averageUtilization: 80
      templates:
        - name: custom-hpa
          type: web
          image:
            repository: nginx
            tag: "latest"
          autoscaling:
            minReplicas: 3
            maxReplicas: 15
            metrics:
              - type: Resource
                resource:
                  name: cpu
                  target:
                    type: Utilization
                    averageUtilization: 70
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.minReplicas
          value: 3
      - equal:
          path: spec.maxReplicas
          value: 15
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 70

  - it: HPA가 비활성화되면 생성되지 않아야 함
    template: hpa.yaml
    set:
      templateDefaults:
        web:
          autoscaling:
            enabled: false
      templates:
        - name: disabled-hpa
          type: web
          image:
            repository: nginx
            tag: "latest"
    asserts:
      - hasDocuments:
          count: 0

  - it: 기본 PodDisruptionBudget이 올바르게 생성되어야 함
    template: poddisruptionbudget.yaml
    set:
      templateDefaults:
        web:
          podDisruptionBudget:
            enabled: true
            minAvailable: 1
      templates:
        - name: basic-pdb
          type: web
          image:
            repository: nginx
            tag: "latest"
    asserts:
      - isKind:
          of: PodDisruptionBudget
      - equal:
          path: spec.minAvailable
          value: 1

  - it: PDB가 비활성화되면 생성되지 않아야 함
    template: poddisruptionbudget.yaml
    set:
      templateDefaults:
        web:
          podDisruptionBudget:
            enabled: false
      templates:
        - name: disabled-pdb
          type: web
          image:
            repository: nginx
            tag: "latest"
    asserts:
      - hasDocuments:
          count: 0 