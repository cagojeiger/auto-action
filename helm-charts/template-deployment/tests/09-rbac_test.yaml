suite: RBAC 기능 테스트
tests:
  - it: 기본 ServiceAccount가 올바르게 생성되어야 함
    template: serviceaccount.yaml
    release:
      name: test-release
    set:
      templateDefaults:
        api:
          serviceAccount:
            create: true
            name: ""
            annotations:
              eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
            automount: true
      templates:
        - name: basic-sa
          type: api
          image:
            repository: nginx
            tag: "latest"
    asserts:
      - isKind:
          of: ServiceAccount
      - hasDocuments:
          count: 1
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: 사용자 지정 ServiceAccount 이름이 올바르게 적용되어야 함
    template: serviceaccount.yaml
    release:
      name: test-release
    set:
      templateDefaults:
        api:
          serviceAccount:
            create: true
            name: ""
      templates:
        - name: custom-sa-name
          type: api
          image:
            repository: nginx
            tag: "latest"
          serviceAccount:
            name: "my-custom-sa"
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: my-custom-sa

  - it: ServiceAccount가 비활성화되면 생성되지 않아야 함
    template: serviceaccount.yaml
    set:
      templateDefaults:
        api:
          serviceAccount:
            create: false
      templates:
        - name: disabled-sa
          type: api
          image:
            repository: nginx
            tag: "latest"
    asserts:
      - hasDocuments:
          count: 0 