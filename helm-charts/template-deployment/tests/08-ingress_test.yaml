suite: 인그레스(Ingress) 기능 테스트
tests:
  - it: 기본 인그레스 설정이 올바르게 적용되어야 함
    template: ingress.yaml
    set:
      templateDefaults:
        web:
          ingress:
            enabled: true
            className: "nginx"
            hosts:
              - host: example.local
                paths:
                  - path: /
                    pathType: Prefix
          service:
            enabled: true
            port: 80
      templates:
        - name: basic-ingress
          type: web
          image:
            repository: nginx
            tag: "latest"
    asserts:
      - isKind:
          of: Ingress
      - equal:
          path: spec.ingressClassName
          value: nginx
      - equal:
          path: spec.rules[0].host
          value: example.local
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: Prefix

  - it: 인그레스 설정이 올바르게 오버라이드되어야 함
    template: ingress.yaml
    set:
      templateDefaults:
        web:
          ingress:
            enabled: true
            className: "nginx"
            hosts:
              - host: example.local
                paths:
                  - path: /
                    pathType: Prefix
          service:
            enabled: true
            port: 80
      templates:
        - name: override-ingress
          type: web
          image:
            repository: nginx
            tag: "latest"
          ingress:
            className: "traefik"
            annotations:
              kubernetes.io/tls-acme: "true"
            hosts:
              - host: custom.example.com
                paths:
                  - path: /api
                    pathType: Exact
          service:
            port: 8080
    asserts:
      - isKind:
          of: Ingress
      - equal:
          path: spec.ingressClassName
          value: traefik
      - equal:
          path: spec.rules[0].host
          value: custom.example.com
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /api
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: Exact
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 8080
      - equal:
          path: metadata.annotations["kubernetes.io/tls-acme"]
          value: "true"

  - it: TLS 설정이 올바르게 적용되어야 함
    template: ingress.yaml
    set:
      templateDefaults:
        web:
          ingress:
            enabled: true
            className: "nginx"
            hosts:
              - host: example.local
                paths:
                  - path: /
                    pathType: Prefix
            tls:
              - secretName: example-tls
                hosts:
                  - example.local
          service:
            enabled: true
            port: 80
      templates:
        - name: tls-ingress
          type: web
          image:
            repository: nginx
            tag: "latest"
    asserts:
      - isKind:
          of: Ingress
      - equal:
          path: spec.tls[0].secretName
          value: example-tls
      - equal:
          path: spec.tls[0].hosts[0]
          value: example.local

  - it: 인그레스가 비활성화되면 생성되지 않아야 함
    template: ingress.yaml
    set:
      templateDefaults:
        web:
          ingress:
            enabled: false
          service:
            enabled: true
            port: 80
      templates:
        - name: disabled-ingress
          type: web
          image:
            repository: nginx
            tag: "latest"
    asserts:
      - hasDocuments:
          count: 0 