name: Generalized Helm Chart Push

on:
  push:
    branches: [ main ]
    paths:
      - 'helm-charts/**'
  workflow_dispatch:
    inputs:
      chart_name:
        description: '특정 차트만 푸시하려면 차트 이름 입력 (예: code-server)'
        required: false
        type: string

jobs:
  detect-charts:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed chart dirs
        id: set
        run: |
          if [ -n "${{ github.event.inputs.chart_name }}" ]; then
            if [ -d "helm-charts/${{ github.event.inputs.chart_name }}" ]; then
              echo "matrix=[\"${{ github.event.inputs.chart_name }}\"]" >> $GITHUB_OUTPUT
              echo "::notice::수동으로 지정된 차트: ${{ github.event.inputs.chart_name }}"
            else
              echo "matrix=[]" >> $GITHUB_OUTPUT
              echo "::error::지정된 차트가 존재하지 않습니다: ${{ github.event.inputs.chart_name }}"
            fi
          else
            changed=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
                     | grep '^helm-charts/' \
                     | awk -F/ '{print $2}' | sort -u)
            
            if [ -z "$changed" ]; then
              echo "matrix=[]" >> $GITHUB_OUTPUT
            else
              json=$(printf '%s\n' $changed | jq -R -s -c 'split("\n")[:-1]')
              echo "matrix=$json" >> $GITHUB_OUTPUT
              echo "::notice::변경된 차트: $json"
            fi
          fi

  push-charts:
    needs: detect-charts
    if: ${{ needs.detect-charts.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-charts.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract chart info
        id: info
        run: |
          DIR="helm-charts/${{ matrix.chart }}"
          CHART_VERSION=$(helm show chart "$DIR" | awk '/^version:/ {print $2}')
          CHART_NAME=$(helm show chart "$DIR" | awk '/^name:/ {print $2}')
          echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_ENV
          echo "CHART_NAME=$CHART_NAME" >> $GITHUB_ENV
          echo "::notice title=Chart Info::name=$CHART_NAME version=$CHART_VERSION"

      - name: Package
        run: |
          helm package "helm-charts/${{ matrix.chart }}" --version ${{ env.CHART_VERSION }}

      - name: Push (OCI)
        run: |
          helm push "${{ env.CHART_NAME }}-${{ env.CHART_VERSION }}.tgz" \
            oci://docker.io/${{ secrets.DOCKERHUB_USERNAME }}
          echo "::notice title=Done::${{ env.CHART_NAME }} v${{ env.CHART_VERSION }} 푸시 완료"
